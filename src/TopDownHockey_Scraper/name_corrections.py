import pandas as pd
import re
import unicodedata

NAME_CORRECTIONS = {
    "ANDREI KASTSITSYN": "ANDREI KOSTITSYN",
    "AJ GREER": "A.J. GREER",
    "ANDREW GREENE": "ANDY GREENE",
    "ANDREW WOZNIEWSKI": "ANDY WOZNIEWSKI",
    "ANTHONY DEANGELO": "TONY DEANGELO",
    "BATES (JON) BATTAGLIA": "BATES BATTAGLIA",
    "BRADLEY MILLS": "BRAD MILLS",
    "CAMERON BARKER": "CAM BARKER",
    "COLIN (JOHN) WHITE": "COLIN WHITE",
    "CRISTOVAL NIEVES": "BOO NIEVES",
    "CHRIS VANDE VELDE": "CHRIS VANDEVELDE",
    "DANNY BRIERE": "DANIEL BRIERE",
    "DANIEL GIRARDI": "DAN GIRARDI",
    "DANNY O'REGAN": "DANIEL O'REGAN",
    "DANIEL CARCILLO": "DAN CARCILLO",
    "DAVID JOHNNY ODUYA": "JOHNNY ODUYA",
    "DAVID BOLLAND": "DAVE BOLLAND",
    "DENIS JR. GAUTHIER": "DENIS GAUTHIER",
    "DWAYNE KING": "DJ KING",
    "EDWARD PURCELL": "TEDDY PURCELL",
    "EMMANUEL FERNANDEZ": "MANNY FERNANDEZ",
    "EMMANUEL LEGACE": "MANNY LEGACE",
    "EVGENII DADONOV": "EVGENY DADONOV",
    "FREDDY MODIN": "FREDRIK MODIN",
    "FREDERICK MEYER IV": "FREDDY MEYER",
    "HARRISON ZOLNIERCZYK": "HARRY ZOLNIERCZYK",
    "ILJA BRYZGALOV": "ILYA BRYZGALOV",
    "JACOB DOWELL": "JAKE DOWELL",
    "JAMES HOWARD": "JIMMY HOWARD",
    "JAMES VANDERMEER": "JIM VANDERMEER",
    "JAMES WYMAN": "JT WYMAN",
    "JOHN HILLEN III": "JACK HILLEN",
    "JOHN ODUYA": "JOHNNY ODUYA",
    "JOHN PEVERLEY": "RICH PEVERLEY",
    "JONATHAN SIM": "JON SIM",
    "JONATHON KALINSKI": "JON KALINSKI",
    "JONATHAN AUDY-MARCHESSAULT": "JONATHAN MARCHESSAULT",
    "JOSEPH CRABB": "JOEY CRABB",
    "JOSEPH CORVO": "JOE CORVO",
    "JOSHUA BAILEY": "JOSH BAILEY",
    "JOSHUA HENNESSY": "JOSH HENNESSY",
    "JOSHUA MORRISSEY": "JOSH MORRISSEY",
    "JEAN-FRANCOIS JACQUES": "J-F JACQUES",
    "JT COMPHER": "J.T. COMPHER",
    "KRISTOPHER LETANG": "KRIS LETANG",
    "KRYSTOFER BARCH": "KRYS BARCH",
    "KRYSTOFER KOLANOS": "KRYS KOLANOS",
    "MARC POULIOT": "MARC-ANTOINE POULIOT",
    "MARTIN ST LOUIS": "MARTIN ST. LOUIS",
    "MARTIN ST PIERRE": "MARTIN ST. PIERRE",
    "MARTY HAVLAT": "MARTIN HAVLAT",
    "MATTHEW CARLE": "MATT CARLE",
    "MATHEW DUMBA": "MATT DUMBA",
    "MATTHEW BENNING": "MATT BENNING",
    "MATTHEW IRWIN": "MATT IRWIN",
    "MATTHEW NIETO": "MATT NIETO",
    "MATTHEW STAJAN": "MATT STAJAN",
    "MAXIM MAYOROV": "MAKSIM MAYOROV",
    "MAXIME TALBOT": "MAX TALBOT",
    "MAXWELL REINHART": "MAX REINHART",
    "MICHAEL BLUNDEN": "MIKE BLUNDEN",
    "MICHAEL CAMMALLERI": "MIKE CAMMALLERI",
    "MICHAEL FERLAND": "MICHEAL FERLAND",
    "MICHAEL GRIER": "MIKE GRIER",
    "MICHAEL KNUBLE": "MIKE KNUBLE",
    "MICHAEL KOMISAREK": "MIKE KOMISAREK",
    "MICHAEL MATHESON": "MIKE MATHESON",
    "MICHAEL MODANO": "MIKE MODANO",
    "MICHAEL RUPP": "MIKE RUPP",
    "MICHAEL SANTORELLI": "MIKE SANTORELLI",
    "MICHAEL SILLINGER": "MIKE SILLINGER",
    "MITCHELL MARNER": "MITCH MARNER",
    "NATHAN GUENIN": "NATE GUENIN",
    "NICHOLAS BOYNTON": "NICK BOYNTON",
    "NICHOLAS DRAZENOVIC": "NICK DRAZENOVIC",
    "NICKLAS BERGFORS": "NICLAS BERGFORS",
    "NICKLAS GROSSMAN": "NICKLAS GROSSMANN",
    "NICOLAS PETAN": "NIC PETAN",
    "NIKLAS KRONVALL": "NIKLAS KRONWALL",
    "NIKOLAI ANTROPOV": "NIK ANTROPOV",
    "NIKOLAI KULEMIN": "NIKOLAY KULEMIN",
    "NIKOLAI ZHERDEV": "NIKOLAY ZHERDEV",
    "OLIVIER MAGNAN-GRENIER": "OLIVIER MAGNAN",
    "PAT MAROON": "PATRICK MAROON",
    "PHILIP VARONE": "PHIL VARONE",
    "QUINTIN HUGHES": "QUINN HUGHES",
    "RAYMOND MACIAS": "RAY MACIAS",
    "RJ UMBERGER": "R.J. UMBERGER",
    "ROBERT BLAKE": "ROB BLAKE",
    "ROBERT EARL": "ROBBIE EARL",
    "ROBERT HOLIK": "BOBBY HOLIK",
    "ROBERT SCUDERI": "ROB SCUDERI",
    "RODNEY PELLEY": "ROD PELLEY",
    "SIARHEI KASTSITSYN": "SERGEI KOSTITSYN",
    "SIMEON VARLAMOV": "SEMYON VARLAMOV",
    "STAFFAN KRONVALL": "STAFFAN KRONWALL",
    "STEVEN REINPRECHT": "STEVE REINPRECHT",
    "TJ GALIARDI": "T.J. GALIARDI",
    "TJ HENSICK": "T.J. HENSICK",
    "TOBY ENSTROM": "TOBIAS ENSTROM",
    "TOMMY SESTITO": "TOM SESTITO",
    "VACLAV PROSPAL": "VINNY PROSPAL",
    "VINCENT HINOSTROZA": "VINNIE HINOSTROZA",
    "WILLIAM THOMAS": "BILL THOMAS",
    "ZACHARY ASTON-REESE": "ZACH ASTON-REESE",
    "ZACHARY SANFORD": "ZACH SANFORD",
    "ZACHERY STORTINI": "ZACK STORTINI",
    "MATTHEW MURRAY": "MATT MURRAY",
    "J-SEBASTIEN AUBIN": "JEAN-SEBASTIEN AUBIN",
    "JEFF DROUIN-DESLAURIERS": "JEFF DESLAURIERS",
    "NICHOLAS BAPTISTE": "NICK BAPTISTE",
    "OLAF KOLZIG": "OLIE KOLZIG",
    "STEPHEN VALIQUETTE": "STEVE VALIQUETTE",
    "THOMAS MCCOLLUM": "TOM MCCOLLUM",
    "TIMOTHY JR. THOMAS": "TIM THOMAS",
    "TIM GETTINGER": "TIMOTHY GETTINGER",
    "NICHOLAS SHORE": "NICK SHORE",
    "T.J. TYNAN": "TJ TYNAN",
    "ALEXIS LAFRENIÈRE": "ALEXIS LAFRENIERE",
    "ALEXIS LAFRENI?RE": "ALEXIS LAFRENIERE",
    "ALEXIS LAFRENIÃRE": "ALEXIS LAFRENIERE",
    'ALEXIS LAFRENIARE': 'ALEXIS LAFRENIERE',
    "TIM STÜTZLE": "TIM STUTZLE",
    "TIM ST?TZLE": "TIM STUTZLE",
    "TIM STÃTZLE": "TIM STUTZLE",
    "TIM STATZLE": "TIM STUTZLE",
    "JANI HAKANPÃ\x84Ã\x84": "JANI HAKANPAA",
    "EGOR SHARANGOVICH": "YEGOR SHARANGOVICH",
    "CALLAN FOOTE": "CAL FOOTE",
    "MATTIAS JANMARK-NYLEN": "MATTIAS JANMARK",
    "JOSH DUNNE": "JOSHUA DUNNE",
    "JANIS MOSER": "J.J. MOSER",
    "NICHOLAS PAUL": "NICK PAUL",
    "JACOB MIDDLETON": "JAKE MIDDLETON",
    "TOMMY NOVAK": "THOMAS NOVAK",
    "JOSHUA NORRIS": "JOSH NORRIS",
    "P.O JOSEPH": "PIERRE-OLIVIER JOSEPH",
    "MIKEY EYSSIMONT": "MICHAEL EYSSIMONT",
    "MATAJ  BLAMEL": "MATAJ BLAMEL",
    "MATEJ BLAMEL": "MATAJ BLAMEL",
    "VITTORIO MANCINI": "VICTOR MANCINI",
    "JOSHUA MAHURA": "JOSH MAHURA",
    "JOSEPH VELENO": "JOE VELENO",
    "ZACK BOLDUC": "ZACHARY BOLDUC",
    "JOSHUA BROWN": "JOSH BROWN",
    "JAKE LUCCHINI": "JACOB LUCCHINI",
    "EMIL LILLEBERG": "EMIL MARTINSEN LILLEBERG",
    "CAMERON ATKINSON": "CAM ATKINSON",
    "JURAJ SLAFKOVSKA": "JURAJ SLAFKOVSKY",
    "MARTIN FEHARVARY": "MARTIN FEHERVARY",
    "JOHN (JACK) ROSLOVIC": "JACK ROSLOVIC",
    "ANTHONY-JOHN (AJ) GREER": "A.J. GREER",
    "ALEX BARRÃ-BOULET": "ALEX BARRE-BOULET",
    "COLIN": "COLIN WHITE CAN",
    "CAMERON TALBOT":"CAM TALBOT",
    'DANIEL VLADAR': 'DAN VLADAR',
    'LUCAS GLENDENING': 'LUKE GLENDENING',
    'FREDDY GAUDREAU': 'FREDERICK GAUDREAU',
    'SAMUEL BLAIS': 'SAMMY BLAIS',
    'ISAC LUNDESTRAM': 'ISAC LUNDESTROM',
    'NATHAN LEGARE': 'NATHAN LAGARA',
    'NATHAN LEGARA': 'NATHAN LAGARA',
    'NATHAN LAGARE': 'NATHAN LAGARA',
    'SAMUEL MONTEMBEAULT': 'SAM MONTEMBEAULT',
    'SAMUEL MONTEMBAULT': 'SAM MONTEMBEAULT',
    'MATTHEW GRZELCYK': 'MATT GRZELCYK',
    'MATEJ BLUMEL': 'MATAJ BLAMEL',
}


# Multiple name mappings (for .isin() checks)
NAME_CORRECTIONS_MULTI = {
    "BJ CROMBEEN": "B.J. CROMBEEN",
    "B.J CROMBEEN": "B.J. CROMBEEN",
    "BRANDON CROMBEEN": "B.J. CROMBEEN",
    "B J CROMBEEN": "B.J. CROMBEEN",
    "DAN CLEARY": "DANIEL CLEARY",
    "DANNY CLEARY": "DANIEL CLEARY",
    "MICHAËL BOURNIVAL": "MICHAEL BOURNIVAL",
    "MICHAÃ\x8bL BOURNIVAL": "MICHAEL BOURNIVAL",
    "J P DUMONT": "J-P DUMONT",
    "JEAN-PIERRE DUMONT": "J-P DUMONT",
    "P. J. AXELSSON": "P.J. AXELSSON",
    "PER JOHAN AXELSSON": "P.J. AXELSSON",
    "PK SUBBAN": "P.K. SUBBAN",
    "P.K SUBBAN": "P.K. SUBBAN",
    "PIERRE PARENTEAU": "P.A. PARENTEAU",
    "PIERRE-ALEX PARENTEAU": "P.A. PARENTEAU",
    "PIERRE-ALEXANDRE PARENTEAU": "P.A. PARENTEAU",
    "PA PARENTEAU": "P.A. PARENTEAU",
    "P.A PARENTEAU": "P.A. PARENTEAU",
    "P-A PARENTEAU": "P.A. PARENTEAU",
    "TJ OSHIE": "T.J. OSHIE",
    "T.J OSHIE": "T.J. OSHIE",
    "J.F. BERUBE": "J-F BERUBE",
    "JEAN-FRANCOIS BERUBE": "J-F BERUBE",
    'GUSTAV LINDSTRAM': 'GUSTAV LINDSTROM',
    'JESSE YLANEN': 'JESSE YLONEN'
}

# Specific name corrections (matching ESPN function)
ESPNNAME_CORRECTIONS = {
    'J T COMPHER': 'J.T. COMPHER',
    'J T MILLER': 'J.T. MILLER',
    'T J OSHIE': 'T.J. OSHIE',
    'ALEXIS LAFRENI RE': 'ALEXIS LAFRENIERE',
    'T.J. BRODIE': 'TJ BRODIE',
    'MATTHEW IRWIN': 'MATT IRWIN',
    'STEVE KAMPFER': 'STEVEN KAMPFER',
    'JEFFREY TRUCHON-VIEL': 'JEFFREY VIEL',
    'ZACHARY JONES': 'ZAC JONES',
    'MATHEW DUMBA': 'MATT DUMBA',
    'JOSHUA MORRISSEY': 'JOSH MORRISSEY',
    'P K SUBBAN': 'P.K. SUBBAN',
    'EGOR SHARANGOVICH': 'YEGOR SHARANGOVICH',
    'MAXIME COMTOIS': 'MAX COMTOIS',
    'NICHOLAS CAAMANO': 'NICK CAAMANO',
    'DANIEL CARCILLO': 'DAN CARCILLO',
    'ALEXANDER OVECHKIN': 'ALEX OVECHKIN',
    'MICHAEL CAMMALLERI': 'MIKE CAMMALLERI',
    'DAVE STECKEL': 'DAVID STECKEL',
    'JIM DOWD': 'JAMES DOWD',
    'MAXIME TALBOT': 'MAX TALBOT',
    'MIKE ZIGOMANIS': 'MICHAEL ZIGOMANIS',
    'VINNY PROSPAL': 'VACLAV PROSPAL',
    'MIKE YORK': 'MICHAEL YORK',
    'JACOB DOWELL': 'JAKE DOWELL',
    'MICHAEL RUPP': 'MIKE RUPP',
    'ALEXEI KOVALEV': 'ALEX KOVALEV',
    'SLAVA KOZLOV': 'VYACHESLAV KOZLOV',
    'JEFF HAMILTON': 'JEFFREY HAMILTON',
    'JOHNNY POHL': 'JOHN POHL',
    'DANIEL GIRARDI': 'DAN GIRARDI',
    'NIKOLAI ZHERDEV': 'NIKOLAY ZHERDEV',
    'J.P. DUMONT': 'J-P DUMONT',
    'DWAYNE KING': 'DJ KING',
    'JOHN ODUYA': 'JOHNNY ODUYA',
    'ROBERT SCUDERI': 'ROB SCUDERI',
    'DOUG MURRAY': 'DOUGLAS MURRAY',
    'VACLAV PROSPAL': 'VINNY PROSPAL',
    'RICH PEVERLY': 'RICH PEVERLEY',
    'JANIS MOSER': 'J.J. MOSER',
    'NICHOLAS PAUL': 'NICK PAUL',
    'JACOB MIDDLETON': 'JAKE MIDDLETON',
    'JOHHNY BEECHER': 'JOHN BEECHER',
    'ALEXANDER BARKOV': 'ALEKSANDER BARKOV',
    'JOSHUA NORRIS': 'JOSH NORRIS',
    'P.O JOSEPH': 'PIERRE-OLIVIER JOSEPH',
    'MIKEY EYSSIMONT': 'MICHAEL EYSSIMONT',
    'MATAJ  BLAMEL': 'MATAJ BLAMEL',
    'VITTORIO MANCINI': 'VICTOR MANCINI',
    'JOSHUA MAHURA': 'JOSH MAHURA',
    'JOSEPH VELENO': 'JOE VELENO',
    'JOSHUA BROWN': 'JOSH BROWN',
    'JAKE LUCCHINI': 'JACOB LUCCHINI',
    'EMIL LILLEBERG': 'EMIL MARTINSEN LILLEBERG',
    'CAMERON ATKINSON': 'CAM ATKINSON',
    'JURAJ SLAFKOVSKA': 'JURAJ SLAFKOVSKY',
    'MARTIN FEHARVARY': 'MARTIN FEHERVARY',
    'JOHN (JACK) ROSLOVIC': 'JACK ROSLOVIC',
    'ANTHONY-JOHN (AJ) GREER': 'A.J. GREER',
    'EGOR CHINAKHOV': 'YEGOR CHINAKHOV',
}

# Merge multi into main dict
NAME_CORRECTIONS.update(NAME_CORRECTIONS_MULTI)

NAME_CORRECTIONS.update(ESPNNAME_CORRECTIONS)

def normalize_player_name(name):
    """Apply the same name normalization as scrape_espn_events"""
    if pd.isna(name) or name == '':
        return name
    
    name = str(name).strip()
    
    # Remove (A) and (C) designations
    name = re.sub(r' \(A\)$', '', name).strip()
    name = re.sub(r' \(C\)$', '', name).strip()
    
    # Normalize unicode characters
    name = unicodedata.normalize('NFKD', name).encode('ascii', errors='ignore').decode('utf-8')
    name = name.upper()
    
    # Clean up multiple spaces BEFORE name corrections lookup
    name = re.sub(r' +', ' ', name)

    # Common name replacements
    name = name.replace('ALEXANDRE ', 'ALEX ')
    name = name.replace('ALEXANDER ', 'ALEX ')
    name = name.replace('CHRISTOPHER ', 'CHRIS ')

    name_corrections = NAME_CORRECTIONS

    name = name_corrections.get(name, name)
    
    return name.strip()